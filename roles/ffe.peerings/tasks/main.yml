---

- name: Ensure bird is installed
  apt: name=bird state=present update_cache=yes

- name: Ensure bird config dir exists
  file: name={{bird_config_dir}} state=directory owner=bird mode=0700

- name: Ensure bird include dirs exists
  file: name={{bird_config_dir}}/{{item}} state=directory owner=bird mode=0700
  with_items:
    - bird.d
    - bird6.d

- name: Configure bird (IPv4)
  template: src=bird.conf.j2 dest={{bird_config_dir}}/bird.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Configure uplink peerings (IPv4)
  template: src=bird.d/uplink.conf.j2 dest={{bird_config_dir}}/bird.d/uplink.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Configure filters (IPv4)
  template: src=bird.d/filters.conf.j2 dest={{bird_config_dir}}/bird.d/filters.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Configure ibgp peerings (IPv4)
  template: src=bird.d/ibgp.conf.j2 dest={{bird_config_dir}}/bird.d/ibgp.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Configure bird (IPv6)
  template: src=bird6.conf.j2 dest={{bird_config_dir}}/bird6.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Configure uplink (IPv6) 
  template: src=bird6.d/uplink.conf.j2 dest={{bird_config_dir}}/bird6.d/uplink.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Configure filters (IPv6)
  template: src=bird6.d/filters.conf.j2 dest={{bird_config_dir}}/bird6.d/filters.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Configure ibgp peerings (IPv6)
  template: src=bird6.d/ibgp.conf.j2 dest={{bird_config_dir}}/bird6.d/ibgp.conf owner=bird mode=0600
  notify: Reload bird daemons

- name: Start and enable bird
  service: name={{item}} state=started enabled=yes
  with_items:
    - bird
    - bird6
